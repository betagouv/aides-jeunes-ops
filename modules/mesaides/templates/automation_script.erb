#!/bin/bash
# <%= @name %> - Managed by puppet from automation_script.sh 

cd $(dirname "$BASH_SOURCE")
set -ev

for line in $(echo $SSH_ORIGINAL_COMMAND | sed 's/ /\n/g' | grep -E '^(<%= @accepted_head_types.join('|') %>)_head=')
do
    key=$(echo $line|grep -o -E '^[^=]*')
    value=$(echo $line|grep -o -E '[^=]*$')

    tmp_path=/tmp/$key
    echo $value > $tmp_path

    head_path=/opt/mes-aides/$key
    mv --backup --suffix=$(date '+.bck_upto_%Y-%m-%d_%H-%M-%S') $tmp_path $head_path
done

export PATH=/opt/puppetlabs/bin:$PATH
puppet apply manifests/<%= @manifest_name %>.pp --verbose --modulepath=modules
<% if @post_command -%>
<%= @post_command %>
<% end -%>
