# MANAGED BY PUPPET
server {
  listen                *:80 default_server;
  server_name           <%= @name %>;

  access_log            /var/log/nginx/<%= @name %>.access.log combined;
  error_log             /var/log/nginx/<%= @name %>.error.log;

  location /.well-known {
    root                <%= @webroot_path %>;
  }
<% if @use_ssl and File.exists?("/etc/letsencrypt/live/#{@name}/fullchain.pem") -%>
  location / {
    return              302 https://$host$request_uri;
  }
<%- else -%>
  location / {
    proxy_pass          http://localhost:8000;
    proxy_redirect      off;
  }
<% end -%>
}

<% if @use_ssl and File.exists?("/etc/letsencrypt/live/#{@name}/fullchain.pem") -%>
server {
    listen              443 ssl;
    server_name         <%= @name %>;

    ssl_certificate     /etc/letsencrypt/live/<%= @name %>/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/<%= @name %>/privkey.pem;

    access_log          /var/log/nginx/<%= @name %>.access.log combined;
    error_log           /var/log/nginx/<%= @name %>.error.log;

    gzip on;
    gzip_proxied        any;
    gzip_types          application/json
                        application/javascript
                        text/css
                        text/plain
                        text/xml;
    gzip_vary           on;

    location / {
      proxy_pass        http://localhost:8000;
      proxy_redirect    off;
    }
}
<% end -%>
