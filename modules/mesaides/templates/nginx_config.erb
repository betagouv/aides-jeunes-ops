# MANAGED BY PUPPET from modules/mesaides/templates/nginx_config.erb
# Modifications should be made in that template

server {
  listen              *:80<% if @is_default %> default_server<% end %>;
  server_name         <%= @name %>;

  access_log          /var/log/nginx/<%= @name %>.access.log combined;
  error_log           /var/log/nginx/<%= @name %>.error.log;

<% if @use_ssl %>
  location /.well-known {
    root              <%= @webroot_path %>;
  }

  <% if true or File.exists?("/etc/letsencrypt/live/#{@name}/fullchain.pem") %>
  location / {
    return            302 https://<%= @name %>$request_uri;
  }
}

server {
  server_name         www.<%= @name %>;
<% ssl_section = %{
  listen              443 ssl;

  ssl_certificate     /etc/letsencrypt/live/#{@name}/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/#{@name}/privkey.pem;

  include snippets/ssl_params.conf;

  access_log          /var/log/nginx/#{@name}.ssl.access.log combined;
  error_log           /var/log/nginx/#{@name}.ssl.error.log;
} %>
  <%= ssl_section %>
  location / {
    return            302 https://<%= @name %>$request_uri;
  }
}

server {
  server_name         <%= @name %>;
  <%= ssl_section %>
  <% end %><%# File.exists?("/etc/letsencrypt/live/#{@name}/fullchain.pem") %>
<% end %><%# @use_ssl %>
  gzip                on;
  gzip_proxied        any;
  gzip_types          application/json
                      application/javascript
                      text/css
                      text/plain
                      text/xml;
  gzip_vary           on;

  location / {
    proxy_pass        <%= @proxied_endpoint %>;
    proxy_redirect    off;
  }
}
