dependencies:
  override:
    - sudo ./bootstrap.sh origin/master origin/$CIRCLE_BRANCH

test:
  override:
    # Test node webserver
    - curl --silent 0.0.0.0:8000 | grep --silent 'mes-aides.gouv.fr'
    # Test NGINX default server
    - curl --silent 0.0.0.0 | grep --silent 'mes-aides.gouv.fr'
    # Test OpenFisca webserver
    - curl --silent 0.0.0.0:2000/variable/parisien | grep --silent openfisca_paris/paris.py
    # Test NGINX configuration for OpenFisca
    - "curl --silent 0.0.0.0/variable/parisien --header 'Host: openfisca.mes-aides.gouv.fr' | grep --silent openfisca_paris/paris.py"
    # Test NGINX configuration for monitor endpoint
    - "curl --silent 0.0.0.0 --header 'Host: monitor.mes-aides.gouv.fr' | grep --silent $CIRCLE_SHA1"
    - initctl list > $CIRCLE_ARTIFACTS/service-list.start.txt
    - grep '^openfisca' $CIRCLE_ARTIFACTS/service-list.start.txt > $CIRCLE_ARTIFACTS/openfisca-service.start.txt
    - sudo /opt/mes-aides/update.sh provision
    - initctl list > $CIRCLE_ARTIFACTS/service-list.post-provision.txt
    - grep '^openfisca' $CIRCLE_ARTIFACTS/service-list.post-provision.txt > $CIRCLE_ARTIFACTS/openfisca-service.post-provision.txt
    - diff $CIRCLE_ARTIFACTS/openfisca-service.post-provision.txt $CIRCLE_ARTIFACTS/openfisca-service.start.txt
    - sudo /opt/mes-aides/update.sh deploy
    - initctl list > $CIRCLE_ARTIFACTS/service-list.post-deploy.txt
    - grep '^openfisca' $CIRCLE_ARTIFACTS/service-list.post-deploy.txt > $CIRCLE_ARTIFACTS/openfisca-service.post-deploy.txt
    - diff $CIRCLE_ARTIFACTS/openfisca-service.post-deploy.txt $CIRCLE_ARTIFACTS/openfisca-service.start.txt


deployment:
  metal:
    branch: master
    owner: betagouv
    commands:
      # CircleCI has a private key only allowed to trigger '/opt/mes-aides/update.sh provision'
      # That command line refreshes Mes-Aides-OPS and UI repositories and re-deploys the services
      - ssh root@metal.mes-aides.gouv.fr
